<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html><head>

<meta content="text/html; charset=ISO-8859-1" http-equiv="content-type"><title>KBase Authentication Tutorial</title></head><body>
<h1>KBase Authentication</h1>

<h2>Prerequisites</h2>
This tutorial assumes that you have downloaded and installed the Perl
Bio::KBase::Auth* libraries from the git repo at
ssh://git@github.com/kbase/auth.git or ssh://kbase@git.kbase.us/auth.git<br>
<br>
After checking a copy of the auth repo, if you are in a normal KBase VM
deployment environment you can use the "install-libs" target in the top
level Makefile. If you are on a laptop or local environment change into
the Bio-KBase-Auth subdirectory and run the following commands:<br>
<br>
perl ./Build.PL<br>
perl ./Build installdeps<br>
perl ./Build install<br>
<br>
This will create the appropriate installer script, then install the dependencies and then install the libraries themselves.<br>
<br>
You will also need the commandline utility "curl" installed in order to test the commandline token examples.<br>
<br>
<h2>Introduction</h2>

<br>
The KBase authentication system is based on OAuth 2.0 with RSA SHA1
signatures for token signing. KBase has partnered with Globus Online to
use the Globus Nexus service to provide a centralized, cross site
identity service. This means that Globus Online operates a service on
our behalf to handle logins, user profiles and group membership. As a
benefit of this, all KBase users automatically get high performance
file transfer through Globus Online, and they are able to link their
home institutions login to their Globus Online account (similar to
linking your account to Facebook or Google/GMail).<br>
<br>
Some features of the Globus Nexus service:<br>
&#8211;OAuth 2.0 compliant<br>
&#8211;REST based backend service for user profiles and groups<br>
&#8211;Supports interactive and programmatic interfaces<br>
&#8211;Supports delegation<br>

&#8211;Supports Username/Password, and RSA key based authentication (using OpenSSH rsa keys)<br>

<br>
Benefits<br>
&#8226;Service is already in operation and has production support<br>&nbsp;&nbsp;&nbsp; &#8211;User registration service is done<br>&nbsp;&nbsp;&nbsp; &#8211;OAuth 2.0 support in place<br>&nbsp;&nbsp;&nbsp;
&#8211;More developers and users banging on code, converges faster on stable
high performance authentication service<br>&nbsp;&nbsp;&nbsp; &#8211;Globus Online will provide custom skinned login instance at appropriate URL<br>
&#8226;Instant tie-in with Globus Online high performance data transfer service<br>
&#8226;Federated logins &#8211; users with accounts in the inCommon Federation have
&#8220;single sign-on&#8221;, linking their home institution accounts into Globus
(more useful for web based apps)<br>
<br>
Drawbacks<br>
&#8226;No longer in control of user profiles &#8211; we are a client, not the master<br>&nbsp;&nbsp;&nbsp; &#8211;We control authorization via groups, instead of directly manipulating accounts<br>
&#8226;We are dependent on another group for feature changes on backend<br>&nbsp;&nbsp;&nbsp; &#8211;The Globus Online guys are mostly ANL guys, and the ANL KBase guys have ready access to them<br>
&#8226;We have outsourced identity to Globus Online<br>
&#8226;We manage authorization internally<br>
&#8226;We can create service accounts within Globus Nexus<br>
&#8226;Tokens are &#8220;bearer tokens&#8221;<br>&nbsp;&nbsp;&nbsp; &#8211;Tokens are not tied to URL, and possession is considered proof of identity<br>
&#8226;Tokens are acquired through several forms of credentials<br>&nbsp;&nbsp;&nbsp; &#8211;RSA signature authentication using SSH public keys<br>&nbsp;&nbsp;&nbsp; &#8211;Normal passwords<br>&nbsp;&nbsp;&nbsp; &#8211;X509 client certificates possible (not currently supports in Kbase libraries)<br>
&#8226;Backend Django service replaced by Globus Online REST service<br>
&#8226;Client API refactored based on observations<br>&nbsp;&nbsp;&nbsp; &#8211;Developers only really seemed to be interested in working with tokens and getting user profiles<br>&nbsp;&nbsp;&nbsp; &#8211;Abstraction based on Client side vs Server side was too heavyweight<br>
&#8226;Tokens are signed using RSA public keys<br>&nbsp;&nbsp;&nbsp; &#8211;No more shared secrets<br>
<br>
<h3>Important URLs</h3>
&nbsp;&nbsp;&nbsp; Here is a list of important URLs related to the authentication system:<br>
<br>
<table style="text-align: left; width: 679px; height: 148px;" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td style="vertical-align: top;"><span style="font-weight: bold;">Browser interface to Globus Online test instance</span></td>
      <td style="vertical-align: top;">
https://test.globuscs.info/ </td>
      <td style="vertical-align: top;">Currently we are testing on this instance. Go here to create test accounts<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top; font-weight: bold;">
Browser interface to Globus Online production instance <br>
      </td>
      <td style="vertical-align: top;">
https://www.globusonline.org/</td>
      <td style="vertical-align: top;">This is the main production instance<br>
for Globus Online, we will migrate to<br>
this instance when appropriate<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;"><span style="font-weight: bold;">Test instance REST API Access</span><br>
      </td>
      <td style="vertical-align: top;">
https://graph.api.test.globuscs.info/</td>
      <td style="vertical-align: top;">Base URL for the REST API, test instance<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;"><span style="font-weight: bold;">Production REST API Access</span><br>
      </td>
      <td style="vertical-align: top;">
https://graph.api.globusonline.org/</td>
      <td style="vertical-align: top;">Base URL for the REST API, production<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;"><span style="font-weight: bold;">REST API Documentation</span><br>
      </td>
      <td style="vertical-align: top;">
http://globusonline.github.com/nexus-docs/api.html</td>
      <td style="vertical-align: top;">Documents the REST API<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;"><span style="font-weight: bold;">Globus Nexus Python Client git repository</span><br>
      </td>
      <td style="vertical-align: top;">
https://github.com/globusonline/python-nexus-client.git</td>
      <td style="vertical-align: top;">Python client code from Globus<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;"><span style="font-weight: bold;">KBase Authentication git repository</span><br>
      </td>
      <td style="vertical-align: top;">
https://github.com/kbase/auth.git</td>
      <td style="vertical-align: top;">KBase Perl client code<br>
      <span style="font-weight: bold; font-style: italic;">used for this tutorial</span><br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;"><span style="font-weight: bold;">Sample Java code for token validation</span><br>
      </td>
      <td style="vertical-align: top;">
ssh://kbase@git.kbase.us/persistent_store.git<br>
 DocumentStoreREST/src/Auth<br>
.../KBaseAuthValidateToken.java<br>
      </td>
      <td style="vertical-align: top;">Sample code in Java<br>
for token validation<br>
      </td>
    </tr>
  </tbody>
</table>
<br><span style="font-weight: bold;"></span><br>
<h2>Working with KBase Authentication Tokens</h2>
In the most basic usage, we want to directly authenticate as a user and
acquire a token, that we can use for subsequent access to KBase
services. We will first show how to do this from the command line,
using the "curl" utility and then show how to do the same thing using
the KBase Perl libraries.<br>
<h3>
Acquiring an authentication token</h3>

<br>
curl -k -# --user papa:papa
'https://graph.api.test.globuscs.info/goauth/authorize?response_type=code&amp;client_id=papa'
| python -m json.tool<br>
<br>
######################################################################## 100.0%<br>
<br>
{<br>
&nbsp;&nbsp;&nbsp; "code":
"un=papa|clientid=papa|expiry=1376522845|SigningSubject=https://graph.api.test.globuscs.info/goauth/keys/861eb8e0-e634-11e1-ac2c-1231381a5994|sig=3fb54b56c7bb9a5c13ea0027e24118dca5b9805a7e401982e4def932a6d78aec34800582c0233da814b57bf438022b0581f013c3aded56bada7479b476c1d67c8aff1dc05627473255a97e93cd7e13e8add6dbdf7f8b23f88b66681fa119a347b8750a33596ae7ca74cfc6355e8e5ba4e32137379abe17fbedeb4520d351315b",<br>
&nbsp;&nbsp;&nbsp; "state": null<br>
<br>
}<br>
<br>
Token Structure<br>
<br>
un=papa|<br>
clientid=papa|<br>
expiry=1376522845|<br>
SigningSubject=https://graph.api.test.globuscs.info/goauth/keys/861eb8e0-e634-11e1-ac2c-1231381a5994|<br>
sig=3fb54b56c7bb9a5c13ea0027e24118dca5b9805a7e401982e4def932a6d78aec34800582c0233da814b57bf438022b0581f013c3aded56bada7479b476c1d67c8aff1dc05627473255a97e93cd7e13e8add6dbdf7f8b23f88b66681fa119a347b8750a33596ae7ca74cfc6355e8e5ba4e32137379abe17fbedeb4520d351315b<br>
<br>
<h3>
Using authentication token to fetch user profile</h3>

<br>curl -k -# -H "X-GLOBUS-GOAUTHTOKEN:
un=papa|clientid=papa|expiry=1376522845|SigningSubject=https://graph.api.test.globuscs.info/goauth/keys/861eb8e0-e634-11e1-ac2c-1231381a5994|sig=3fb54b56c7bb9a5c13ea0027e24118dca5b9805a7e401982e4def932a6d78aec34800582c0233da814b57bf438022b0581f013c3aded56bada7479b476c1d67c8aff1dc05627473255a97e93cd7e13e8add6dbdf7f8b23f88b66681fa119a347b8750a33596ae7ca74cfc6355e8e5ba4e32137379abe17fbedeb4520d351315b"
'https://graph.api.test.globuscs.info/users/papa' | python -m json.tool<br>
<br>
######################################################################## 100.0%<br>
<br>
{<br>
&nbsp;&nbsp;&nbsp; "custom_fields": {},<br>
&nbsp;&nbsp;&nbsp; "email": "papa@smurfs.nz",<br>
&nbsp;&nbsp;&nbsp; "email_validated": true,<br>
&nbsp;&nbsp;&nbsp; "fullname": "Papa Smurf",<br>
&nbsp;&nbsp;&nbsp; "opt_in": null,<br>
&nbsp;&nbsp;&nbsp; "system_admin": true,<br>
&nbsp;&nbsp;&nbsp; "username": "papa"<br>
}<br>
<br>
<h3>
Getting a Token on the commandline using perl libraries</h3>

<br>Using username/password authentication:<br>
<br>
sychan$ perl -MBio::KBase::AuthToken -e 'print
Bio::KBase::AuthToken-&gt;new( user_id =&gt; "papa", password =&gt;
"papa")-&gt;token,"\n";'<br>
<br>un=papa|clientid=papa|expiry=1376542920|SigningSubject=https://graph.api.test.globuscs.info/goauth/keys/861eb8e0-e634-11e1-ac2c-1231381a5994|sig=2e81ffa18b1803588228f475d35ae9d8c1b5c582a46dbbb49d7944662dc349791b6b0ac5e4a6b89c406de1dc83eff1a961cb9892a45398636809fce4ff7f70b2a76a384cd3361a4f6bdd25d72b1affb413717abf6b499ecffff19037cce7fd2367135c3e736398c1c26d429ecb827635a3aae8a92c7beae1c87760df958eecb2<br>
<br>Using username/RSA authentication:<br>
<br>
sychan$ perl -MBio::KBase::AuthToken -e '$key=`cat ~/.ssh/id_rsa`;
print Bio::KBase::AuthToken-&gt;new( user_id =&gt; "sychan",
client_secret =&gt; $key)-&gt;token,"\n";&#8217;<br>
<br>
un=sychan|clientid=sychan|expiry=1376543282|SigningSubject=https://graph.api.test.globuscs.info/goauth/keys/861eb8e0-e634-11e1-ac2c-1231381a5994|sig=afa6f7ad6389f3775a1142cc16b9f223e299d0e75e154182731e8405167ac447281ba70b6eee97939276463f71ecdb466f65ab70f6b96ebec9666e443b81fb795eace1b9fe1d05a055edb6afb623bbf601330f2363db0701c82656de81a10e58fa0c955b4794e08c0407a48771e1c660ad78cd2d0338c6b4a72e514892d32f2<br>
<br>
<br>
<h3>Sample Perl script</h3>
<h4>Basic AuthToken and AuthUser usage</h4>
<br>
use Bio::KBase::AuthToken;<br>
use Bio::KBase::AuthUser;<br>
use Data::Dumper;<br>
<br>
$t = Bio::KBase::AuthToken-&gt;new( user_id =&gt; "papa",<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; password
=&gt; "papa");<br>
<br>
if ($t-&gt;validate()) {<br>
&nbsp;&nbsp;&nbsp; print "Yeehaw!!! It works!\n";<br>
&nbsp;&nbsp;&nbsp; print Dumper( $t);<br>
&nbsp;&nbsp;&nbsp; $u = Bio::KBase::AuthUser-&gt;new( token =&gt; $t-&gt;token);<br>
&nbsp;&nbsp;&nbsp; if ($t-&gt;user_id()) {<br>
&nbsp; &nbsp;&nbsp;&nbsp; print "And here's my profile object:\n";<br>
&nbsp; &nbsp;&nbsp;&nbsp; print Dumper( $u);<br>
&nbsp;&nbsp;&nbsp; }<br>
} else {<br>
&nbsp;&nbsp;&nbsp; die "Doh!\n";<br>
}<br>
<br>
Yeehaw!!! It works!<br>
<br>
$VAR1 = bless( {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 'password'
=&gt; 'papa',<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
'error_message' =&gt; undef,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 'user_id'
=&gt; 'papa',<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 'token' =&gt;
'un=papa|clientid=papa|expiry=1376544425|SigningSubject=https://graph.api.test.globuscs.info/goauth/keys/861eb8e0-e634-11e1-ac2c-1231381a5994|sig=805ab020da27e5b77416ce8e76431cd5941a1a2c527ef3c89ff04a4b2a2de1fa94e7e40517364224b89aeec19269aabb960435a6d144b7911ee62801b2143c5061808504f9815930dd7f55150cbdfec7203331466c744b9dd62d674d459b4efbd39f2ff2d3249ae8f2d4eb41d17d5263ae6ddd8a43bed0a555005c2edc299076'<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; },
'Bio::KBase::AuthToken' );<br>
<br>
And here's my profile object:<br>
<br>
$VAR1 = bless( {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 'system_admin'
=&gt; 1,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 'name' =&gt;
'Papa Smurf',<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 'phone' =&gt;
'8888888888',<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 'email' =&gt;
'papa@smurfs.nz',<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 'oauth_creds'
=&gt; {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 'auth_token'
=&gt;
'un=papa|clientid=papa|expiry=1376544425|SigningSubject=https://graph.api.test.globuscs.info/goauth/keys/861eb8e0-e634-11e1-ac2c-1231381a5994|sig=805ab020da27e5b77416ce8e76431cd5941a1a2c527ef3c89ff04a4b2a2de1fa94e7e40517364224b89aeec19269aabb960435a6d144b7911ee62801b2143c5061808504f9815930dd7f55150cbdfec7203331466c744b9dd62d674d459b4efbd39f2ff2d3249ae8f2d4eb41d17d5263ae6ddd8a43bed0a555005c2edc299076'<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
},<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
'error_message' =&gt; undef,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 'current_project_name' =&gt; 'Papa',<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 'verified'
=&gt; 1,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 'user_id'
=&gt; 'papa',<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 'token' =&gt;
undef,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 'organization'
=&gt; 'papa',<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 'institution'
=&gt; 'papa',<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 'opt_in' =&gt;
undef<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; },
'Bio::KBase::AuthUser' );<br>
<br>
&nbsp;<br>
<br>
<h4>
Example Client and Server code using AuthToken and AuthUser:</h4>

<br>
use lib "../lib/";<br>
use lib "lib";<br>
use Data::Dumper;<br>
use HTTP::Daemon;<br>
use HTTP::Request;<br>
use LWP::UserAgent;<br>
use JSON;<br>
use Bio::KBase::AuthToken;<br>
use Bio::KBase::AuthUser;<br>
<br>
sub testServer {<br>
&nbsp;&nbsp;&nbsp; my $d = shift;<br>
&nbsp;&nbsp;&nbsp; my $res = new HTTP::Response;<br>
&nbsp;&nbsp;&nbsp; my $msg = new HTTP::Message;<br>
&nbsp;&nbsp;&nbsp; my $at = new Bio::KBase::AuthToken;<br>
&nbsp;&nbsp;&nbsp; while (my $c = $d-&gt;accept()) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while (my $r = $c-&gt;get_request) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; my $token = $r-&gt;header('Authorization');<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $at-&gt;token( $token);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ($at-&gt;validate()) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $res-&gt;code(200);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
$body = sprintf( "Successfully logged in as user %s\n",
$at-&gt;user_id);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
$au = Bio::KBase::AuthUser-&gt;new( 'token' =&gt; $at-&gt;token);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
printf "Server: User %s (%s) found for token %s.\n",
$au-&gt;name,$au-&gt;user_id, $at-&gt;token;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $res-&gt;code(401);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
printf "Server: token failed validation.\n";<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
$body = sprintf("You failed to login: %s\n", $at-&gt;error_message);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $res-&gt;content( $body);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $c-&gt;send_response($res);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $c-&gt;close;<br>
&nbsp;&nbsp;&nbsp; }<br>
}<br>
<br>
sub testClient {<br>
&nbsp;&nbsp;&nbsp; my $server = shift; my $ua =
LWP::UserAgent-&gt;new(); my $req = HTTP::Request-&gt;new( GET =&gt;
$server. "someurl" );<br>
<br>
&nbsp;&nbsp;&nbsp; $at = Bio::KBase::AuthToken-&gt;new('user_id' =&gt; 'kbasetest', 'password' =&gt; '@Suite525');<br>
&nbsp;&nbsp;&nbsp; $req-&gt;header("Authorization" =&gt; $at-&gt;token);<br>
<br>
&nbsp;&nbsp;&nbsp; $res = $ua-&gt;request( $req);<br>
&nbsp;&nbsp;&nbsp; printf "Client: Recieved a response: %d %s\n", $res-&gt;code, $res-&gt;content;<br>
<br>
&nbsp;&nbsp;&nbsp; # As a sanity check, trash the oauth_secret and make sure that<br>
&nbsp;&nbsp;&nbsp; # we get a negative result<br>
&nbsp;&nbsp;&nbsp; $req-&gt;header("Authorization" =&gt; "bogo token");<br>
<br>
&nbsp;&nbsp;&nbsp; printf "Client: Sending bad request: %s %s (expecting failure)\n",$req-&gt;method,$req-&gt;url-&gt;as_string;<br>
&nbsp;&nbsp;&nbsp; $res = $ua-&gt;request( $req);<br>
&nbsp;&nbsp;&nbsp; printf "Client: Recieved a response: %d %s\n", $res-&gt;code, $res-&gt;content;<br>
<br>
}<br>
<br>
$d = HTTP::Daemon-&gt;new( LocalAddr =&gt; '127.0.0.1');<br>
<br>
printf "Server listening at %s\n",$d-&gt;url;<br>
<br>
my $child = fork();<br>
if ($child) {<br>
&nbsp;&nbsp;&nbsp; testClient( $d-&gt;url);<br>
} else {<br>
&nbsp;&nbsp;&nbsp; testServer( $d);<br>
}<br>
<br>
kill 9, $child;<br>
<br>
<br>

Output from the sample script:<br>
<br>
Server listening at http://127.0.0.1:54079/<br>
Server: User KBase Test Account (kbasetest) found for token
un=kbasetest|clientid=kbasetest|expiry=1376547165|SigningSubject=https://graph.api.test.globuscs.info/goauth/keys/861eb8e0-e634-11e1-ac2c-1231381a5994|sig=9a8fcd2a41e877aec5b0ed5a0d0315c258b5466d4862d17b5ce33f2703d2a32e8179556579998a8379271360251593b9db86430fb9bd1b9bf081b39dc6ff978bde834a9a9cb19eacc46f0b4ada93048c10b8aa2bfa2325ba5fab6993042b51bc7e3ab1545831c261e96972f3789fd20b6c1c5742f937ffda8a6f08c3019ca0d1.<br>
Client: Recieved a response: 200 Successfully logged in as user kbasetest<br>
<br>
Client: Sending bad request: GET http://127.0.0.1:54079/someurl (expecting failure)<br>
Server: token failed validation.<br>
Client: Recieved a response: 401 You failed to login: Failed to verify
token: Token lacks signature fields at lib/Bio/KBase/AuthToken.pm line
237.<br>
<br>
<h3>Validating Authentication Tokens</h3>
Sample Token:<br>
<span style="background-color: rgb(153, 255, 153);">un=kbasetest|clientid=kbasetest|expiry=1376547165|SigningSubject=https://graph.api.test.globuscs.info/goauth/keys/861eb8e0-e634-11e1-ac2c-1231381a5994</span>|<span style="background-color: rgb(51, 204, 255);">sig=9a8fcd2a41e877aec5b0ed5a0d0315c258b5466d4862d17b5ce33f2703d2a32e8179556579998a8379271360251593b9db86430fb9bd1b9bf081b39dc6ff978bde834a9a9cb19eacc46f0b4ada93048c10b8aa2bfa2325ba5fab6993042b51bc7e3ab1545831c261e96972f3789fd20b6c1c5742f937ffda8a6f08c3019ca0d1</span><br>
Token Contents = Green<br>
Token Signature = Blue<br>
<br>
From sample token:<br>
SigningSubject=https://graph.api.test.globuscs.info/goauth/keys/861eb8e0-e634-11e1-ac2c-1231381a5994<br>
<br>
SigningSubject points to JSON object:<br>
{<br>
&nbsp;&nbsp;&nbsp; "expiry": 1345569705.0, <br>
&nbsp;&nbsp;&nbsp; "id": "861eb8e0-e634-11e1-ac2c-1231381a5994", <br>
&nbsp;&nbsp;&nbsp; "pubkey": "-----BEGIN RSA PUBLIC
KEY-----\nMIGJAoGBAOI4NghMHlbChfx07ZeLY4eiOiJUb9ofnv+cnFOFEmP+BrxZObT3RpuD\nC2jjIX78lj16LaQPxz5iaFth3FJCxERgcjnlQ5nvgHAwisRG+76Y8fIpgGAdWL5S\nzrlgDOXVieYs+N06fGPmlsMRtQVEzy0fUa5421epiNRKy5QYZskPAgMBAAE=\n-----END
RSA PUBLIC KEY-----\n", <br>
&nbsp;&nbsp;&nbsp; "valid": true<br>
}<br>
<br>
Pseudocode for token validation, given the "pubkey" in the JSON object referenced above:<br>
<br>
<span style="background-color: rgb(153, 255, 153);">un=kbasetest|clientid=kbasetest|expiry=1376547165|SigningSubject=https://graph.api.test.globuscs.info/goauth/keys/861eb8e0-e634-11e1-ac2c-1231381a5994</span>|<span style="background-color: rgb(51, 204, 255);">sig=9a8fcd2a41e877aec5b0ed5a0d0315c258b5466d4862d17b5ce33f2703d2a32e8179556579998a8379271360251593b9db86430fb9bd1b9bf081b39dc6ff978bde834a9a9cb19eacc46f0b4ada93048c10b8aa2bfa2325ba5fab6993042b51bc7e3ab1545831c261e96972f3789fd20b6c1c5742f937ffda8a6f08c3019ca0d1</span><br>
If (RSA_SHA1_Base64(Green Stuff, pubkey) == Blue Stuff) {<br>
&nbsp;&nbsp;&nbsp; # Happiness!!<br>
} else {<br>
&nbsp;&nbsp;&nbsp; # Sucks<br>
}<br>
<br>
OAuth 2.0 compliant &#8230;but&#8230;<br>
<ul>
  <li>OAuth 2.0 bearer token structure undefined</li>
  <li>The Globus Online bearer tokens are custom and use our own validation scheme</li>
  <li>Focus has been on REST interface for authentication, have not
pushed on full OAuth browser flowsweb interfaces with callbacks not
yet implemented</li>
</ul>
Globus Online has assigned a hierarchy of groups rooted at &#8220;kbase&#8221;<br>
<ul>
  <li>See groups API at http://globusonline.github.com/nexus-docs/api.html#groups</li>
  <li>Create an account on Globus, and we can assign admin privs on that tree to that account</li>
</ul>
<br>
</body></html>