
<h1>Developing Software in the KBase Environment</h1>
<p><strong>Purpose: </strong> More detail on techniques and standards
for developing and deploying software in KBase.
</p>
<p><strong>Required Prerequisite Activities: </strong> <a href="/for-users/get-started/">Getting
Started with KBase</a> </p>
<p> <strong>Suggested Prerequisite Activities: </strong> <a href="/for-users/tutorials/retrieving-data/basics-in-retrieving-data-from-kbase/">Basics in Retrieving Data from KBase</a> </p>
<p> </p>
<p><strong>Related Tutorials:</strong> <a href="/developer-zone/tutorials/getting-started/installing-the-kbase-dmg/">Getting
Started with the KBase Tools: Mac Edition </a> and other
Developer tutorials. </p>
<h2>A Tutorial on Developing and Deploying Software<br>
</h2>
<p>We define a standard design for the environment in which KBase
application and service code is developed.
</p>
<p>This design assumes the understanding of some concepts that should
be familiar to most Linux software developers:
</p>
<ul>
  <li>Navigation in the Unix filesystem</li>
  <li>Basic shell commands<br>
  </li>
  <li>Make and makefiles</li>
</ul>
<p> All development happens in a directory that we are calling a <span style="font-style: italic;">development container</span>. The
development container provides a framework that provides the necessary
build and installation support for the creation of new software
modules.
</p>
<h2>A Note on Languages</h2>
<p>While it is clear that all software developed for the KBase is
implemented in some programming language, the content of this document
is language-neutral. We will define specific procedures and tools for
each of the supported KBase programming languages in a <a name="family722">family</a> of related documents. However, the
language specific details will conform to the set of conventions we
outline here.
</p>
<p>It is important to understand the motivation behind the set of
design choices that have been made in this deployment architecture. We
consider the following principles to be important:
</p>
<ul>
  <li>
    <p>Software development and testing should be performed in the same
environment that is used for production deployments. That is, no
further engineering of the source code should be required in order to
place the code into production.</p>
  </li>
</ul>
<ul>
  <li>
    <p>A single mechanism should, to the extent possible, be used for
the deployment of software into production. Each of the scripting
languages in common use has well-engineered mechanisms for the
distribution and installation of software in that language. However,
these mechanisms are all different. We would prefer to have a release
engineering procedure that is the same across the supported languages.
This way, an engineer responsible for the packaging and testing of the
KBase for instance, needs to understand the KBase release engineering
strategy, not all of the release engineering strategies for all
languages in use.</p>
  </li>
</ul>
<ul>
  <li>
    <p>The KBase release and deployment process must be automatable
both for installation on to new hardware and for the support of
automated build and testing.</p>
  </li>
  <li>
    <p>Programs intended to be run at the command line (either directly
by a user at an interactive prompt or via the Iris interactive
execution service) must not require any external environment variables
to operate properly. As a result we tend to use a common design pattern
where, at least for the scripting languages, the command line programs
are actually shell scripts (or on Windows, batch files) that initialize
the runtime environment properly and then invoke the actual script.
These wrappers are automatically generated by the development container
infrastructure.</p>
  </li>
</ul>
<p> Some of the choices that have been made may seem strange to some
individuals. The authors are coming from a language background that is
Unix-heavy and raised on the customs and traditions of the Unix and C
language environment. </p>
<h2>Prerequisites</h2>
<p>We assume that you are starting with an operational KBase
environment. There are a number of ways to obtain such an environment.
</p>
<p>If you have an Apple Mac computer, you can download a pre-packaged
Mac application that includes all the developent tools. This is
available from the <a href="/downloads" target="_blank">tools
page on the KBase developer website</a>.
</p>
<p>Moving forward we will also provide a Windows package. The KBase
login nodes (for KBase developers with access to the KBase linux
infrastructure) also contain a KBase environment.
</p>
<h2>Anatomy of the KBase Environment</h2>
<p>We use several different terms when discussing the KBase development
environments.
</p>
<p>A <span style="font-style: italic;">KBase deployment</span> is an
installation of a set of KBase <span style="font-style: italic;">modules</span>
into an installation directory.
</p>
<p style="margin-left: 40px;">Please excuse our use of such a generic
term. It is unfortunate that the word "module" has a number of meanings
in a project like this - source code control systems speak in terms of
modules of code under management; programming langauges break code into
named modules; etc. We hope the specific meaning is clear in context. A
KBase module is the smallest unit of software release in the KBase
environment. We intend that a KBase module contain all the code related
to a particular component of the KBase architecture. We anticipate that
there will be a one to one mapping between KBase modules and
source-code management (SCM) system modules - that is, each KBase
module is stored in a single module in a SCM. <br>
</p>
<p>A deployment is the product of KBase development; that is, it
includes the applications and services that are available to be run by
end users of the KBase. A deployment makes use of a <span style="font-style: italic;">KBase runtime</span> installation. The
runtime includes the runtime support for each of the languages
implementing modules in the deployment, as well as any other third
party software that are dependencies of the deployment. Some of the
third party dependencies may be met by the host operating system on the
machine where the KBase deployment is installed, but any that are not
will be installed as part of the runtime. </p>
<p>KBase software development (for software that is intended to become
part of a deployment) takes place in a <span style="font-style: italic;">development container</span>. The
development container is a directory structure that serves as a host
environment for one or more <span style="font-style: italic;">KBase
modules</span>. The module is the basic unit of software release within
the KBase environment.
</p>
<p>The development container provides a makefile structure and support
scripts that support the installation of the modules into a standard
KBase deployment.<br>
</p>
<h2>Module Types</h2>
<p>There are several different types of modules that may be created
within the KBase environment. Please note these types are not
necessarily precisely defined, and the functionality of a module may
incorporate elements of multiple types. A <span style="font-style: italic;">script module</span> contains code that is
intended to be run by a user at the command line (or via the Iris
interactive interface). The source for the command line scripts will be
in the directory <span style="font-family: monospace;">scripts</span>
in the source module. </p>
<p>A<span style="font-style: italic;"> service module</span> contains
code that implements a KBase service. The top level of the module
directory will contain the typespec document defining the service, and
the library code for the implementation of the service will be found
under the <span style="font-family: monospace;">lib</span>
subdirectory. This module also contains scripts for starting and
stopping the service, as well as a <a href="http://mmonit.com/monit/" target="_blank">monit</a> process definition stanza, in the <span style="font-family: monospace;">services</span> stubdirectory. The
Makefile for a service includes rules for rebuilding the source modules
from the type specification document.<br>
</p>
<h2>Creating a Development Container</h2>
<p>The first step in setting up for development is to create a
development container in which to work. This is done using the <span style="font-family: monospace;">kb_create_dev_container</span>
command:
</p>
<pre style="margin-left: 40px;">$ <span style="font-weight: bold;">kb_create_dev_container /home/olson/container-work idserver typecomp kb_seed dev_container_tools</span> <br></pre>
<p>This will create a new development container in <span style="font-family: monospace;">/home/olson/container-work</span> and
initialize it with the idserver, typecomp, kb_seed and
dev_container_tools modules. <br>
</p>
<p>Module names specified as above (as simple terms) are assumed to
come from the standard KBase git repository. That is, if one refers to
the module "idserver", a <span style="font-family: monospace;">git
clone</span> operation will be performed using the fully-specified
module "kbase@git.kbase.us/idserver.git". One may specfiy other full
git URLs, or Mercurial URLs prefixed with "hg:".<br>
</p>
<p>When using a development container, you will need to source the file
<span style="font-family: monospace;">user-env.sh </span>that you will
find at its top level. This script, automatically generated by the
development container bootstrap process, initializes your command path
and library definition paths for any language runtimes in use by the
container:<br>
</p>
<p style="margin-left: 40px;"><span style="font-family: monospace;">$ <span style="font-weight: bold;">cd /home/olson/container-work</span><br>
$ <span style="font-weight: bold;">source user-env.sh</span></span><br>
</p>
<p>To complete the initialization we run make at the toplevel of the
development container
</p>
<p style="margin-left: 40px;"><span style="font-family: monospace;">$ <span style="font-weight: bold;">make</span></span><br>
After that is complete, if you list the contents of the bin directory
you should see a number of scripts, and the following kb_seed script
should work for you:<br>
<br>
</p>
<div style="margin-left: 40px; font-family: monospace;">
<p>$ <span style="font-weight: bold;">echo 'kb|g.0' | <a href="/developer-zone/documentation/cdm-entity-relationship-command-scripts/#get_entity_Genome" target="_blank">get_entity_Genome</a> -f scientific_name,source_id</span><br>
kb|g.0&nbsp;&nbsp;&nbsp; Escherichia coli K12&nbsp;&nbsp;&nbsp; 83333.1</p>
</div>
<h2>The KBase Module</h2>
<p>Each KBase module has the same structure; this structure is designed
to enable the standard build and deploy mechanisms used for KBase.
</p>
<p>The following components are found in each module:
</p>
<ul>
  <li>A toplevel <span style="font-style: italic;">Makefile</span>
contains the logic for the standard build and deployment process for
KBase modules. These Makefiles are invoked by the toplevel Makefile in
the development container, and are responsible for creatingany script
wrappers for the programs. </li>
</ul>
The following components may be missing in some modules, but some set
of them will be present in any module.<br>
<ul>
  <li>
    <p>A directory <span style="font-style: italic;">scripts<span style="font-style: italic;"><span style="font-style: italic;"><span style="font-style: italic;"> </span></span></span></span>containing
the source code for command-line scripts provided by this module. The
filenames in this directory will have the typical suffixes used for
source files in the given programming language (e.g., .pl for Perl
code, .py for Python code, etc.); these suffixes are used by the build
infrastructure to allow the proper installation of the command scripts.
The suffix will be dropped on the installation of the scripts, so that
"mycmd.pl" will be executed by the end-user by invoking "mycmd".</p>
  </li>
  <li>
    <p>A directory <span style="font-style: italic;">lib</span>
containing the library files for the module. Any directory structure
required by the scripting language will be created here. For instance,
the KBase ID server libraries are in the <a name="Bio::KBase723">Bio::KBase</a>::IDServer
namespace, so the actual perl files for that module will be found in
the directory lib/Bio/KBase/IDServer.</p>
  </li>
  <li>
    <p>A directory <span style="font-style: italic;">service</span>
containing service startup and shutdown scripts<br>
    </p>
  </li>
</ul>
<p> Please note that these standards are evolving. It is clear that we
will need to tune the process to support languages like Java and C++
that require an explicit compilation step and that may have more
sophisticated requirements in the generation and use of libraries.
</p>
<h2>Creating a New Module<br>
</h2>
<p> In order to ease new developers into the KBase development model we
have provided scripts that bootstrap the creation of new source
modules. <br>
</p>
<p><span style="font-style: italic;">The support for new-script
creation modules is as yet incomplete. The intent is to provide
developers with fully-functional skeletons for the development of new
code in any of the supported programming languages. </span><br>
</p>
<h3>Script modules<br>
</h3>
<p>To create a new script module, use the program <span style="font-family: monospace;">kb_create_script_module</span>. This
program creates a new module and stubs of the script names that you
provide on the command line. <br>
</p>
<h3>Service modules</h3>
<p>To create a new service module, use the program <span style="font-family: monospace;">kb_create_service_module</span>. <br>
</p>
<h2>Modifying Existing Code</h2>
<p>If your task involves changing an existing KBase code module and you
have checked out into your development container using the original <span style="font-family: monospace;">kb_create_dev_container</span>
command, you will find the code in the directory <span style="font-family: monospace;">modules/&lt;module-name&gt;</span>.
Changes to existing files will take effect immediately - it is not
necessary to rerun <span style="font-family: monospace;">make</span>
for changes in scripts or library files to take effect. If a new
command line script is added, you will need to rerun the make at the
top level to construct a new script-wrapper for the script. If a new
module is added, the toplevel <span style="font-family: monospace;">bootstrap</span>
script will need to be rerun (no arguments are necessary) in order to
update the files that have module paths included (these include <span style="font-family: monospace;">user-env.sh</span> and the generated
wrapper scripts).
</p>
<h2>Deployment and Service Configuration</h2>
<p>To deploy and configure your module there is a master configuration
file that controls what services are deployed and where a deployed
service can connect to its service dependencies. </p>
<p> The location of the top level deployment configuration is located
at &lt;dev_container&gt;/deploy.cfg. When the deployment task is run
the process copies this configuration file to
/kb/deployment/deploy.cfg. <br>
</p>
<p>The configuration file is a simple INI-style configuration file. We
expect the following top-level configuration variables to be defined:
</p>
<dl>
  <dt id="deploy-service">deploy-service</dt>
  <dd>
    <p>Specify a list of comma-separated module names that are to be
deployed as services. ("Deployed as a service" means that a "make
deploy-service" will eventually be invoked on the module).</p>
  </dd>
  <dt id="deploy-client">deploy-client</dt>
  <dd>
    <p>Specify a list of comma-separated module names that are to be
deployed as clients. ("Deployed as a client" means that a "make
deploy-client" will eventually be invoked on the module).</p>
    <p>Client deployments are typically used to either provide
command-line programs to be executed on the deployment's host, or to
provide libraries that are prerequisites for other modules in the
deployment.</p>
  </dd>
  <dt id="target">target</dt>
  <dd>
    <p>Directory into which the deployment will be installed. On a
production deployment this is typically /kb/deployment, but for testing
a user may deploy into any directory.</p>
  </dd>
  <dt id="deploy-runtime">deploy-runtime</dt>
  <dd>
    <p>The directory containing the KBase runtime that the deployment
will use. This will contain the perl, python, or other scripting
language runtime environments that the deployment requires, along with
any other third-party software dependencies of the deployment.</p>
  </dd>
</dl>
<p>For each module being configured, a configuration stanza may be
defined. These stanzas are named using the module name in square
brackets:
</p>
<pre><code>  [idserver]</code></pre>
<p>and may contain a set of configuration variables. Each of these
configuration variables will passed to the make invocation on the given
module. The variable names are transformed to names in the typical
style of makefiles by uppercasing all characters and transforming any
"-" (dash) characters to "_" (underscore). For example, a configuration
file stanza containing
</p>
<pre><code>  service      = cdmi_api<br>  service-port = 7034<br>  mysql-host   = db1.chicago.kbase.us<br>  mysql-user   = seed<br>  mysql-db     = kbase_sapling</code></pre>
<p>will result in a make command line containing
</p>
<pre><code>  SERVICE=cdmi_api SERVICE_PORT=7034 MYSQL_HOST=db1.chicago.kbase.us MYSQL_USER=seed MYSQL_DB=kbase_sapling</code></pre>
